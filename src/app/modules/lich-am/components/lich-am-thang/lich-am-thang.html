<div class="card">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-auto">
        <label class="form-label mb-1">Năm</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="selectedYear"
          (change)="onMonthChange()"
        />
      </div>
      <div class="col-auto">
        <label class="form-label mb-1">Tháng</label>
        <select
          class="form-select"
          [(ngModel)]="selectedMonth"
          (change)="onMonthChange()"
        >
          <option
            *ngFor="let m of months"
            [value]="m"
          >
            {{ m }}
          </option>
        </select>
      </div>
      <div class="col-auto">
        <button
          class="btn btn-outline-primary"
          type="button"
          (click)="goToday()"
        >
          Hôm nay
        </button>
      </div>
      <div class="col">
        <div class="text-end text-muted">Nhấn vào ô ngày để xem chi tiết.</div>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive mt-3">
  <table class="table calendar table-bordered mb-0 text-center align-middle">
    <thead class="table-light">
      <tr>
        <th
          class="bg-dark text-light text-center fw-bold"
          colspan="7"
        >
          LỊCH THÁNG {{selectedMonth}} NĂM {{selectedYear}}
        </th>
        <!-- <th class="bg-success text-white"></th> -->
      </tr>
      <tr>
        <th class="bg-dark text-light">T2</th>
        <th class="bg-dark text-light">T3</th>
        <th class="bg-dark text-light">T4</th>
        <th class="bg-dark text-light">T5</th>
        <th class="bg-dark text-light">T6</th>
        <th class="bg-dark text-light">T7</th>
        <th class="bg-dark text-light">CN</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let week of weeks">
        <td
          *ngFor="let day of week"
          (click)="selectCell(day)"
          [class.bg-success-subtle]="day.iso === selectedDateIso"
          [class.text-muted]="!day.inMonth"
          class="day-cell"
        >
          <span
            class="day-dot"
            [ngClass]="{
              'dot-good': day.mood === 'good',
              'dot-bad': day.mood === 'bad',
              'dot-neutral': day.mood === 'neutral'
            }"
          ></span>
          <div class="fw-semibold day mb-2">{{ day.day }}</div>
          <div class="lunar-text small text-secondary">
            {{ day.lunarDay }}/{{ day.lunarMonth }}{{ day.lunarLeap ? " (N)" : "" }}
          </div>
          <div class="lunar-text small text-secondary">
            {{ day.canChiNgay }}
          </div>
          <small
            *ngIf="day.isToday"
            class="text-danger"
            >Hôm nay</small
          >
        </td>
      </tr>
    </tbody>
  </table>
  <div class="container-fluid bg-white border border-secondary">
    <p><span class="day-dot dot-good mt-3"></span> Ngày hoàng đạo</p>
    <p><span class="day-dot dot-bad"></span> Ngày hắc đạo</p>
  </div>
</div>

@if (detail) {
<div class="table-responsive mt-3 mb-3">
  <table class="table detail-date table-bordered mb-0 align-middle">
    <thead class="table-light">
      <tr>
        <th
          class="bg-dark text-white text-center fw-bold"
          colspan="2"
        >
          THÔNG TIN NGÀY {{ detail.solarDate }}
        </th>
        <!-- <th class="bg-success text-white"></th> -->
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="fw-bold">Thông tin cơ bản</td>
        <td>
          <p><strong>Dương lịch</strong> {{ detail.solarDate }}</p>
          <p>
            <strong>Âm lịch</strong> {{ detail.lunarDate
            }}{{ detail.lunarLeap ? " (Nhuận)" : "" }}
            Năm
            {{ detail.canChiNam }}
          </p>
          <p><strong>Can Chi ngày</strong> {{ detail.canChiNgay }}</p>
          <p><strong>Can Chi tháng</strong> {{ detail.canChiThang }}</p>
          <p><strong>Can Chi năm</strong> {{ detail.canChiNam }}</p>
          @if (detail.ngayHoangDao.type === 'Hắc đạo') {
            <p><strong>Ngày hắc đạo</strong> Sao {{ detail.ngayHoangDao.sao }}</p>
          }
          @if (detail.ngayHoangDao.type === 'Hoàng đạo') {
            <p><strong>Ngày hoàng đạo</strong> Sao {{ detail.ngayHoangDao.sao }}</p>
          }
          <p><strong>Nạp âm</strong> {{ detail.napAm }}</p>
          <p><strong>Đánh giá ngũ hành</strong> {{ detail.nguHanhDanhGia }}</p>
          <p><strong>Tiết khí</strong> {{ detail.tietKhi }}</p>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Ngũ hành & Quan hệ</td>
        <td>
          <p><strong>Can (ngày):</strong> {{ detail.nguHanhCan }}</p>
          <p><strong>Chi (ngày):</strong> {{ detail.nguHanhChi }}</p>
          <p>
            <strong>Lục hợp:</strong> {{ detail.xungHop.lucHop || "—" }} — <strong>Tam hợp:</strong>
            {{ detail.xungHop.tamHop ? detail.xungHop.tamHop.join(", ") : "—" }}
          </p>
          <p>
            <strong>Xung:</strong> {{ detail.xungHop.xung || "—" }} —
            <strong>Hình/Hại/Phá/Tuyệt:</strong>
            {{ detail.xungHop.hinh || "" }} / {{ detail.xungHop.hai || "" }} / {{ detail.xungHop.pha || "" }} /
            {{ detail.xungHop.tuyet || "" }}
          </p>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Lục diệu</td>
        <td>
          <p>
            <strong>{{ detail.lucDieuName }}</strong
            >: {{ detail.lucDieuDesc }}
          </p>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Giờ hoàng đạo</td>
        <td>
          <p *ngIf="detail.gioHoangDao.length; else noHoangDao">
            {{ detail.gioHoangDao.join(", ") }}
          </p>
          <ng-template #noHoangDao><span>Không có</span></ng-template>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Thập nhị kiến trừ (Trực)</td>
        <td>
          <p>
            <strong>{{ detail.truc.key }}</strong>
          </p>
          <p><strong>Mô tả:</strong> {{ detail.truc.data.moTa }}</p>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Bành Tổ (Bách kỵ nhật)</td>
        <td>
          <ul class="mb-0">
            <li><strong>Theo CAN ngày:</strong> {{ detail.banhTo.canStr }}</li>
            <li><strong>Theo CHI ngày:</strong> {{ detail.banhTo.chiStr }}</li>
            <li><strong>Theo ngày âm:</strong> {{ detail.banhTo.lunarStr }}</li>
          </ul>
        </td>
      </tr>
      <!-- <tr>
        <td class="fw-bold">Ngày kỵ / Trùng tang / Trùng phục (Chưa đúng)</td>
        <td>
          <p>{{NGAY_KY.trungTang}}</p>
          <p>Trùng Tang: {{TRUNG_TANG.join(', ')}}</p>
          <p>Trùng Phục: {{TRUNG_PHUC.join(', ')}}</p>
        </td>
      </tr> -->
      <tr>
        <td class="fw-bold">Nhị thập bát tú</td>
        <td>
          <p>
            <strong>{{ detail.nhiThapBatTu.key }}</strong> — {{ detail.nhiThapBatTu.data.sao }} ({{
              detail.nhiThapBatTu.data.loai
            }})
          </p>
          <p>{{ detail.nhiThapBatTu.data.moTa }}</p>
          <p><strong>Nên:</strong> {{ detail.nhiThapBatTu.data.nen || "—" }}</p>
          <p><strong>Kiêng:</strong> {{ detail.nhiThapBatTu.data.ky || "—" }}</p>
        </td>
      </tr>
      <!-- <tr>
        <td class="fw-bold">Ngọc hạp - Sao tốt / xấu (chưa đúng)</td>
        <td>
          <p>Danh sách sao tốt tiêu biểu: {{saoTotTieuBieu.join(', ')}}</p>
          <p>Danh sách sao xấu tiêu biểu: {{saoXauTieuBieu.join(', ')}}</p>
          <ul class="mb-0">
            <li *ngFor="let sao of detail.ngocHapList"
              [ngClass]="{'text-success': sao.type==='good', 'text-danger': sao.type==='bad'}">
              <strong>{{sao.k}}:</strong> {{sao.v}}
            </li>
            <li *ngIf="!detail.ngocHapList.length">Không có sao đặc biệt theo phần dữ liệu hiện tại.</li>
          </ul>
        </td>
      </tr> -->
      <tr>
        <td class="fw-bold">Hướng xuất hành (chưa đúng)</td>
        <td>
          <ul class="mb-0">
            <li *ngFor="let h of detail.huongList">
              <strong>{{ h.k }}:</strong> {{ h.v }}
            </li>
          </ul>
        </td>
      </tr>
      <tr>
        <td class="fw-bold">Ghi chú giờ xuất hành (Ly Thuần Phong)</td>
        <td>
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Chi</th>
                <th>Khung giờ</th>
                <th>Ghi chú</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let g of detail.gioXuatHanhNotes">
                <td class="fw-semibold">{{ g.chi }}</td>
                <td>{{ g.range }}</td>
                <td>{{ g.note }}</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
</div>
}
